<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <title>PHP - Получаем гео-инфо пользователя по IP | Atoumus Blog</title> <link rel="alternate" href="http://atoumus.github.io/php-detect-country-by-ip.html" hreflang="ru" /> <link rel="alternate" href="http://atoumus.github.io/en/" hreflang="en" /> <link rel="alternate" type="application/atom+xml" title="Atoumus Blog" href="/atom.xml" /> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" type="text/css" href="/css/libs/flaticon/flaticon.css"> <link rel="stylesheet" type="text/css" href="/css/libs/prism.css"> <link rel="stylesheet" type="text/css" href="/css/libs/prism-fix.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css" /> <link rel="stylesheet" type="text/css" href="/css/common.css"> </head> <body> <a href="#top" class="elevator"><span class="flaticon-upwards-arrow"></span></a> <a name="top"></a> <div class="main"> <div class="header"> <a href="/" class="logo" title="Atoumus Blog" ><img src="/images/logo.png">Atoumus Blog</a> <form class="search" action="//google.com/search" target="_blank" method="get" accept-charset="UTF-8"> <input type="search" name="q" class="search-input"> <button type="submit">Поиск</button> <input type="hidden" name="sitesearch" value="http://atoumus.github.io"> </form> <div class="social"> <a href="#" class="search-toggle flaticon-magnifier" title="Поиск"></a> <a href="/atom.xml" target="_blank" class="flaticon-rss-feed-button" title="Atom лента"></a> <a href="https://twitter.com/atoumus/" target="_blank" class="flaticon-twitter-logo-silhouette" title="Twitter"></a> <a href="https://plus.google.com/u/0/116624784918762784912" target="_blank" class="flaticon-google-plus-logo-button" title="G+"></a> </div> </div> <div class="clear-both"></div> <div class="menu"> <div class="tags"> <a href='/'>Главная</a><a href='/tag/Yii/'>Yii</a><a href='/tag/PHP/' class='selected'>PHP</a><a href='/tag/Books/'>Книги</a><a href='/tag/Zend Framework/'>Zend Framework</a><a href='/tag/Drupal/'>Drupal</a><a href='/tag/Learning/'>Обучение</a><a href='/tag/WebGrind/'>WebGrind</a><a href='/tag/C Sharp/'>C#</a><a href='/tag/Others/'>Прочее</a> </div> <div class="lang-switcher"> <span>ru</span><a href='/en/'>en</a> </div> </div> <div class="clear-both"></div> <div class="contents"> <div class="article"> <h1>PHP - Получаем гео-инфо пользователя по IP</h1> <div class="meta"> <div> <span class="flaticon-calendar-with-spring-binder-and-date-blocks"></span> 2016-03-16 </div> <div> <span class="flaticon-commerce"></span> <a href='/tag/PHP/'>PHP</a>, <a href='/tag/GeoIP/'>GeoIP</a>, <a href='/tag/Sypex Geo/'>Sypex Geo</a>, <a href='/tag/IP2LOCATION/'>IP2LOCATION</a>, <a href='/tag/TabGeo/'>TabGeo</a> </div> <div class="comments-number"> <span class="flaticon-comment-white-oval-bubble"></span> <a href="#comments" data-disqus-url="http://atoumus.github.io/php-detect-country-by-ip.html"></a> </div> </div> <div class="clear-both"></div> <div class="text"><p>В продолжение темы про IP, в этой статье будут рассмотрены способы определения страны, города и другой гео-ино о пользователе по его IP.</p>   <h2>GeoIP в виде PHP расширения</h2> <p>Наверное самая часто используемая библиотека для определения IP (<a target="_blank" href="http://php.net/manual/ru/book.geoip.php">оф. док на php.net</a>). Оно и не мудрено, ведь бинарная БД + скомпилированное PHP расширение работают быстрее всех остальных способов.</p> <p>Установка на Ubuntu Server:</p> <pre><code class="language-bash">sudo apt-get install php5-geoip</code></pre> <p>После установки скачиваем последние обновления базы IP адресов:</p> <pre class="line-numbers"><code class="language-bash">sudo wget -N http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
sudo gunzip GeoIP.dat.gz
sudo mv GeoIP.dat /usr/share/GeoIP/</code></pre> <p>После этих действий необходимо перезагрузить PHP. Это нужно для того что бы PHP интерпретатор подгрузил только что установленное расширение (php5-geoip) и новые базы IP адресов.</p> <pre class="line-numbers"><code class="language-bash">sudo service php5-fpm restart # если вы используете NGINX
# или
sudo service apache2 restart # если вы используете Apache</code></pre> <p>Также периодически необходимо обновлять базы IP адресов:</p> <pre class="line-numbers"><code class="language-bash">sudo wget -N http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
sudo gunzip GeoIP.dat.gz
sudo mv GeoIP.dat /usr/share/GeoIP/</code></pre> <p>После обновления так же необходимо перезагружать PHP для применения обновленной базы IP адресов:</p> <pre class="line-numbers"><code class="language-bash">sudo service php5-fpm restart # если вы используете NGINX
# или
sudo service apache2 restart # если вы используете Apache</code></pre> <p>После того как GeoIP установлен, его можно использовать в коде, например так:</p> <pre class="line-numbers"><code class="language-php">&lt;?php
$countryCode = geoip_country_code_by_name($_SERVER['REMOTE_ADDR']);
echo $countryCode;</code></pre> <h2>GeoIP в виде composer пакета</h2> <p>Этот способ, почти идентичен с GeoIP в виде расширения для PHP, за одним исключением: вам не нужно устанавливать на сервер дополнительные расширения.</p> <p>Полезно это в том случае, если у вас нет root прав к серверу и вы не можете устанавливать PHP расширения.</p> <p>Недостаток этого способа в том что он работает немного медленнее в сравнении со скомпилированным PHP расширением.</p> <p>Подробную инструкцию можно почитать на <a target="_blank" href="https://maxmind.github.io/GeoIP2-php/">офф. сайте</a>, я лиш расскажу вкратце.</p> <p>Первым делом необходимо скачать БД IP адресов в специальном формате (.mmdb) с <a target="_blank" href="http://dev.maxmind.com/geoip/geoip2/geolite2/">офф. сайта</a>, и поместить его в любую папку на сервере которая вам доступна:</p> <pre class="line-numbers"><code class="language-bash">wget -N http://geolite.maxmind.com/download/geoip/database/GeoLite2-Country.mmdb.gz
gunzip GeoLite2-Country.mmdb.gz
mv GeoLite2-Country.mmdb /my-site/data/GeoIP/</code></pre> <p>Далее установить через composer офф. пакет geoip:</p> <pre><code class="language-bash">composer require geoip2/geoip2:~2.0</code></pre> <p>После этих двух несложных действий, можно начинать его использовать в своих PHP скриптах, пример:</p> <pre class="line-numbers"><code class="language-php">&lt;?php

require 'vendor/autoload.php';

use GeoIp2\Database\Reader;

$reader = new Reader('/my-site/data/GeoIP/GeoLite2-Country.mmdb');

$geo = $reader-&gt;country($_SERVER['REMOTE_ADDR']);
var_dump($geo-&gt;country-&gt;isoCode);
var_dump($geo-&gt;country-&gt;name);</code></pre> <h2>Sypex Geo</h2> <p>Офф. сайт: <a target="_blank" href="https://sypexgeo.net/ru/"><a target="_blank" href="https://sypexgeo.net/ru/">https://sypexgeo.net/ru/</a></a></p> <p>Также поставляется в виде PHP класса и бинарной библиотеки. К сожалению офф. composer пакета у нее нет. Но можно воспользоваться и не офф: <a target="_blank" href="https://packagist.org/packages/igi/sypexgeo"><a target="_blank" href="https://packagist.org/packages/igi/sypexgeo">https://packagist.org/packages/igi/sypexgeo</a></a>.</p> <p>Этот composer пакет хорош еще тем, что позволяет при выполнении команды &quot;composer install&quot; обновлять БД IP адресов.</p> <p>Для того что бы установить этот composer пакет и настроить авто обновление БД IP адресов, нужно в файле composer.json прописать следующие настройки:</p> <pre class="line-numbers"><code class="language-json">{
    "require-dev": {
        "igi/sypexgeo": "@dev"
    },
    "scripts": {
        "post-install-cmd": [
            "IgI\\SypexGeo\\Composer::installDatabases"
        ]
    },
    "extra": {
        "sypexgeo_remote": "https://sypexgeo.net/files/SxGeoCountry.zip",
        "sypexgeo_local": "/var/www/at0m1x.dev/test/data/SxGeo.dat"
    }
}</code></pre> <p>Обратите внимание на следующие настройки:</p> <ul> <li>подключение пакета необходимо располагать в секции require-dev</li> <li>при подключении пакета необходимо указывать уровень стабильности @dev</li> <li>в секции sypexgeo_remote вместо SxGeoCountry.zip можно указать SxGeoCity_utf8.zip</li> <li>в параметре sypexgeo_local вам необходимо указать свой путь к папке</li> </ul> <p>Далее выполняем установку composer пакетов:</p> <pre><code class="language-bash">composer install</code></pre> <p>После установки самой библиотеки, обновится и БД IP адресов с офф. сайта.</p> <p>Пример использования в PHP коде:</p> <pre class="line-numbers"><code class="language-php">&lt;?php

require 'vendor/autoload.php';

$sxGeo = new \IgI\SypexGeo\SxGeo(__DIR__ . '/data/SxGeo.dat');
var_dump($sxGeo-&gt;getCountry('89.163.220.14'));</code></pre> <p>Кроме использования composer пакета, также можно использовать REST API этого проекта, пример: <a target="_blank" href="http://api.sypexgeo.net/json/89.163.220.14">http://api.sypexgeo.net/json/89.163.220.14</a> Об онлайн сервисах для определения гео инфы читайте ниже в этой статье. </p> <h2>IP2LOCATION</h2> <p>Офф. сайт: <a target="_blank" href="http://www.ip2location.com/">http://www.ip2location.com/</a></p> <p>Еще одна composer библиотека из-за рубежа.</p> <p>Установка:</p> <pre><code class="language-bash">composer require ip2location/ip2location-php</code></pre> <p>При установки этого composer пакета, и также при его обновлении, также будет обновляться БД IP адресов, которая находится по такому пути:</p> <pre><code>/vendor/ip2location/ip2location-php/databases/IP2LOCATION-LITE-DB1.BIN</code></pre> <p>Использование:</p> <pre class="line-numbers"><code class="language-php">&lt;?php

require 'vendor/autoload.php';

$db = new \IP2Location\Database(
    __DIR__ . '/vendor/ip2location/ip2location-php/databases/IP2LOCATION-LITE-DB1.BIN',
    \IP2Location\Database::FILE_IO
);

$records = $db-&gt;lookup('89.163.220.14', \IP2Location\Database::ALL);

echo '&lt;pre&gt;';
echo 'IP Number             : ' . $records['ipNumber'] . "\n";
echo 'IP Version            : ' . $records['ipVersion'] . "\n";
echo 'IP Address            : ' . $records['ipAddress'] . "\n";
echo 'Country Code          : ' . $records['countryCode'] . "\n";
echo 'Country Name          : ' . $records['countryName'] . "\n";
echo '&lt;/pre&gt;';</code></pre> <h2>TabGeo</h2> <p>Офф. сайт: <a target="_blank" href="http://tabgeo.com/ru/index/">http://tabgeo.com/ru/index/</a></p> <p>Появился сравнительно не давно, первая версия composer пакета была опубликована 27 сентября 2015.</p> <p>Позиционирует себя как самый быстрый, по сравнению с такими конкурентами как: GeoIP и Sypex Geo. Но скорость достигается за счет малого размера базы, в следствии чего эта библиотека определяет только код страны.</p> <p>Распространяется в виде composer пакета + бинарная БД в своем собственном формате.</p> <p>Для установки этой библиотеки нужно всего лиш подключить composer пакет:</p> <pre><code class="language-bash">composer require tabgeo/country</code></pre> <p>При этом установится как PHP библиотека так и сама БД:</p> <p style="text-align: center;"><img src="/images/ru/articles/2016-03-16-php-detect-country-by-ip/tabgeo.png" alt="PHP - получаем гео-инфо пользователя по IP" /></p> <p>Пример использования в PHP скрипте:</p> <pre class="line-numbers"><code class="language-php">&lt;?php

require 'vendor/autoload.php';

$country = TabGeo\country('89.163.220.14');
var_dump($country);</code></pre> <p>Стоит заметить, что TabGeo позволяет получить только двузначный код страны в формате <a target="_blank" href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">ISO 3166-1 alpha-2</a>. Если вам нужно что то большее, например определить регион, город, временную зону, или пр., то нужно использовать например тот же GeoIP, т.к. он позволяет все это определить.</p> <h2>Онлайн сервисы для гео-таргетинга</h2> <p>В качестве альтернативы можно использовать специальные онлайн сервисы. Принцип их работы прост: передаем GET параметром IP и в ответ получаем гео-инфу в формате JSON или XML.</p> <p>Преимущество этого способы в том, что его можно использовать не только на стороне PHP, но и на стороне например JavaScript.</p> <p>Но есть и существенные недостатки:</p> <ul> <li>работает это не так быстро как PHP библиотека;</li> <li>вы не можете обновить БД IP адресов;</li> <li>ваш сервер могут заблокировать за частые обращения.</li> </ul> <p>Вот несколько таких онлайн сервисов:</p> <ul> <li><a target="_blank" href="http://ipgeobase.ru:7020/geo?ip=89.163.220.14">ipgeobase.ru</a></li> <li><a target="_blank" href="http://www.geoplugin.net/json.gp?ip=89.163.220.14">geoplugin.net</a></li> <li><a target="_blank" href="http://api.sypexgeo.net/json/89.163.220.14">sypexgeo.net</a></li> </ul> <h2>Заключение</h2> <p>Почти все вышеперечисленные библиотеки предоставляют два вида баз данных IP адресов:</p> <ul> <li>облегченный, только со списком стран, как правило в названии содержит Country;</li> <li>более полный, в котором кроме стран также содержится инфо о крупных городах, как правило в названии содержит City и больше весит;</li> </ul> <p>Более полная БД IP адресов с городами конечно будет работать немного медленнее в силу того что она больше по объему.</p> <p>Наиболее правильно использовать GeoIP в виде PHP расширения. Т.к. работать он будет всегда и быстро. Также вы всегда можете обновить базы IP адресов.</p> <p>Если нет возможности установить GeoIP в виде PHP расширения, то можно использовать один из composer пакетов: GeoIP, Sypex Geo, IP2LOCATION или TabGeo.</p> <p>Если же использование composer пакета по какой-то причине не возможно, тогда остается использовать онлайн сервисы. Но обязательно нужно сделать кеширование запросов на эти сервисы в свою БД. Кеширование нужно для того что бы не отправлять один и тот же запрос по много раз. Достаточно один раз получить гео-инфу по интересующему ИП через онлайн сервис, после чего сохранить ее к себе в БД, и далее брать уже из БД. Таким образом вы уменьшите кол-во запросов на онлайн сервис и уменьшите вероятность того что онлайн сервис вас заблокирует за множественные запросы.</p> <p>Стоит заметить, что почти у всех вышеперечисленных библиотек есть бесплатные и платные версии. В платных версиях вам будет доступно больше гео инфы чем в бесплатных.</p></div> <div class="related"> <h2>Читайте также</h2> <a href="/test-site-by-other-country-ip.html" target="_blank" >Как проверить сайт под IP другой страны через прокси сервер</a> <a href="/php-tech-ratings.html" target="_blank" >PHP Full Stack Web Dev - требования и рейтинг технологий</a> </div> <div class="share">Поделится: <script type="text/javascript">(function () { if (window.pluso) if (typeof window.pluso.start == "function") return; if (window.ifpluso == undefined) { window.ifpluso = 1; var d = document, s = d.createElement('script'), g = 'getElementsByTagName'; s.type = 'text/javascript'; s.charset = 'UTF-8'; s.async = true; s.src = ('https:' == window.location.protocol ? 'https' : 'http') + '://share.pluso.ru/pluso-like.js'; var h = d[g]('body')[0]; h.appendChild(s); } })();</script> <div class="pluso" data-background="transparent" data-options="small,round,line,horizontal,counter,theme=04" data-services="vkontakte,odnoklassniki,facebook,twitter,google,moimir,email,print"></div></div>   <div class="comments"> <a name="comments"></a> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = "http://atoumus.github.io/php-detect-country-by-ip.html"; this.language = "ru"; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://atoumus.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> </div> <div class="footer"> <div class="left"> <div class="social"> <a href="#" class="icon search-toggle flaticon-magnifier" title="Поиск"></a> <a href="/atom.xml" target="_blank" class="icon flaticon-rss-feed-button" title="Atom лента"></a> <a href="https://twitter.com/atoumus/" target="_blank" class="icon flaticon-twitter-logo-silhouette" title="Twitter"></a> <a href="https://plus.google.com/u/0/116624784918762784912" target="_blank" class="icon flaticon-google-plus-logo-button" title="G+"></a> </div> <div class="author-email"> <a data-email-array='{"6":"s","0":"a","11":"i","1":"t","7":"@","2":"o","15":"o","10":"a","16":"m","9":"m","5":"u","13":".","8":"g","14":"c","4":"m","12":"l","3":"u"}' href="#"></a> </div> <div class="donate"> <a href="http://yasobe.ru/na/atoumus_blog" target="_blank">Поддержать финансово</a> </div> </div> <div class="right"> <div>  <script type="text/javascript"> document.write("<a href='//www.liveinternet.ru/click' "+ "target=_blank><img src='//counter.yadro.ru/hit?t25.5;r"+ escape(document.referrer)+((typeof(screen)=="undefined")?"": ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth? screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+ ";"+Math.random()+ "' alt='' title='LiveInternet: показано число посетителей за"+ " сегодня' "+ "border='0' width='88' height='15'><\/a>") </script>  </div> <div> Atoumus Blog &copy; 2011 - 2018 </div> <div> Копирование и цитирование с обязательным указанием URL ссылки на оригинал страницы </div> </div> </div> <div class="clear-both"></div> </div> <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script> <script type="text/javascript" src="/js/libs/prism.js"></script> <script type="text/javascript" src="/js/common.js"></script> </body> </html>