<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <title>PHP - Управление cron'ом с помощью cron_manager.sh | Atoumus Blog</title> <link rel="alternate" href="http://atoumus.github.io/php-manage-cron-sh.html" hreflang="ru" /> <link rel="alternate" href="http://atoumus.github.io/en/" hreflang="en" /> <link rel="alternate" type="application/atom+xml" title="Atoumus Blog" href="/atom.xml" /> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" type="text/css" href="/css/libs/flaticon/flaticon.css"> <link rel="stylesheet" type="text/css" href="/css/libs/prism.css"> <link rel="stylesheet" type="text/css" href="/css/libs/prism-fix.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css" /> <link rel="stylesheet" type="text/css" href="/css/common.css"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-4863431788441395", enable_page_level_ads: true }); </script> <meta name="yandex-verification" content="b1ff017a4540ff81" /> </head> <body> <a href="#top" class="elevator"><span class="flaticon-upwards-arrow"></span></a> <a name="top"></a> <div class="main"> <div class="ads"></div> <div class="clear-both"></div> <div class="header"> <a href="/" class="logo" title="Atoumus Blog" ><img src="/images/logo.png">Atoumus Blog</a> <form class="search" action="//google.com/search" target="_blank" method="get" accept-charset="UTF-8"> <input type="search" name="q" class="search-input"> <button type="submit">Поиск</button> <input type="hidden" name="sitesearch" value="http://atoumus.github.io"> </form> <div class="social"> <a href="#" class="search-toggle flaticon-magnifier" title="Поиск"></a> <a href="/atom.xml" target="_blank" class="flaticon-rss-feed-button" title="Atom лента"></a> <a href="https://twitter.com/atoumus/" target="_blank" class="flaticon-twitter-logo-silhouette" title="Twitter"></a> <a href="https://plus.google.com/u/0/116624784918762784912" target="_blank" class="flaticon-google-plus-logo-button" title="G+"></a> </div> </div> <div class="clear-both"></div> <div class="menu"> <div class="tags"> <a href='/'>Главная</a><a href='/tag/PHP/'>PHP</a><a href='/tag/Yii/'>Yii</a><a href='/tag/Books/'>Книги</a><a href='/tag/Zend Framework/'>Zend Framework</a><a href='/tag/Drupal/'>Drupal</a><a href='/tag/XDebug/'>XDebug</a><a href='/tag/C Sharp/'>C#</a><a href='/tag/Sublime Text/'>Sublime Text</a><a href='/tag/Others/' class='selected'>Прочее</a> </div> <div class="lang-switcher"> <span>ru</span><a href='/en/'>en</a> </div> </div> <div class="clear-both"></div> <div class="contents"> <div class="article"> <h1>PHP - Управление cron'ом с помощью cron_manager.sh</h1> <div class="meta"> <div> <span class="flaticon-calendar-with-spring-binder-and-date-blocks"></span> 2016-04-02 </div> <div> <span class="flaticon-commerce"></span> <a href='/tag/Cron/'>Cron</a>, <a href='/tag/Bash/'>Bash</a>, <a href='/tag/Linux/'>Linux</a> </div> <div class="comments-number"> <span class="flaticon-comment-white-oval-bubble"></span> <a href="#comments" data-disqus-url="http://atoumus.github.io/php-manage-cron-sh.html"></a> </div> </div> <div class="clear-both"></div> <div class="text"><p>В каждом PHP проекте есть скрипты которые нужно запускать по крону. Когда таких скриптов становиться много, то возникает необходимость их хранить в каком-то конфиге проекта. А если еще и нет root доступа к серверу, то каждый раз дергать админа что бы он поставил какой то скрипт на крон, совсем не удобно. В этой статье пойдет речь о том, как управлять cron задачами в проекте, не имея root прав, с помощью скрипта <a target="_blank" href="https://github.com/atoumus/cron_manager.sh">cron_manager.sh</a>.</p>   <p>Скрипт <a target="_blank" href="https://github.com/atoumus/cron_manager.sh">cron_manager.sh</a> представляет собой удобный инструмент, который может считывать конфиги cron задач лежащие в папке проекта, и на их основе добавлять/изменять/удалять cron задачи в ОС сервера. Для этого скрипта не требуются root права. Cron задачи сохраняются в cron файл, который принадлежит текущему linux пользователю.</p> <p>Скрипт <strong>cron_manager.sh не привязан конкретно к PHP</strong>, он может управлять задачами cron и в любых других проектах. Мы же рассмотрим пример именно с PHP для наглядности.</p> <p>Скрипт имеет две команды:</p> <ul> <li>update - для добавления/изменения/удаления cron задач на основе вашего конфига;</li> <li>clear - для удаления всех cron задач вашего проекта.</li> </ul> <p>Данный скрипт удобно использовать совместно с какой либо из систем CI, например Jenkins. Т.к. можно в скрипт сборки проекта написать команду, которая будет автоматически запускать cron_manager.sh.</p> <h2>Устанавливаем cron_manager.sh в ОС Linux</h2> <p>Удобней всего будет установить cron_manager.sh глобально в Linux, для этого выполняем следующие команды:</p> <pre class="line-numbers"><code class="language-bash">sudo su
cd /usr/local/bin/
wget -O cron_manager https://raw.githubusercontent.com/atoumus/cron_manager.sh/master/cron_manager.sh
chmod a+x cron_manager</code></pre> <p>После этих действий его можно будет просто запускать командой <code>$ cron_mananger</code>. </p> <h2>Создаем конфиг файл</h2> <p>Прежде всего необходимо положить в проект конфиг файл, в котором будет храниться список cron задач. Название этого файла может быть каким угодно, расположение также не имеет значения. Формат записи cron задач в этом файле точно такой же как если бы вы добавляли задачи cron вручную. Пример содержания такого файла:</p> <pre class="line-numbers"><code class="language-cron">* * * * * /var/www/site.com/test1.php

# Some comment
* * * * * /var/www/site.com/test2.php</code></pre> <p>Т.е. ничего особенного, просто cron задачи в обычном формате. Также в конфиг файле могут содержаться комментарии которые должны начинаться с символа <code>#</code>, они не будут добавлены в системный cron.</p> <h2>Команда update</h2> <p>После того как конфиг создан, можно начинать использовать скрипт cron_manager.sh для добавления задач в cron.</p> <p>У скрипта cron_manager.sh есть одна важная особенность. Текущий каталог воспринимается как корневой каталог проекта. Поэтому <strong>обязательно необходимо перейти в корневой каталог проекта</strong>.</p> <p>Далее, из корневого каталога проекта, необходимо запустить команду update:</p> <pre><code class="language-bash">$ cron_manager update ./crontab</code></pre> <p>В выше приведенном примете <code>./crontab</code> и является конфигом со списком cron задач, который лежит в вашем проекте. Этот конфиг файл может находиться и в каком либо подкаталоге, необязательно в корне проекта.</p> <p>При выполнении команды <code>update</code> скрипт cron_manager.sh отобразит подробную инфо о том какие задачи были добавлены.</p> <p>Если в конфиге <code>./crontab</code> сделать какие либо изменения и повторно запустить команду <code>update</code>, то сделанные изменения также применяться в системном cron'е.</p> <p>Так что все что нужно для управления cron задачами в проекте, это вносить их в конфиг файл и запускать команду <code>update</code> скрипта cron_manager.sh.</p> <h2>Команда clear</h2> <p>Данная команда позволяет очистить все cron задачи текущего проекта из системного cron'а. Это удобно например тогда, когда проект переносят в другое место на сервере, или вообще на другой сервер, и нужно из системного cron'а удалить все задачи которые относятся к проекту.</p> <p>Прежде всего <strong>переходим в корневую папку проекта</strong>. После этого запускаем команду <code>clear</code>, при этом конфиг cron задач проекта указывать уже не нужно:</p> <pre><code class="language-bash">$ cron_manager clear</code></pre> <p>При выполнении этой команды скрипт cron_manager.sh также выдаст подробную инфу о том какие именно задачи были удалены из системного cron'а.</p></div> <div class="share">Поделится: <script type="text/javascript">(function () { if (window.pluso) if (typeof window.pluso.start == "function") return; if (window.ifpluso == undefined) { window.ifpluso = 1; var d = document, s = d.createElement('script'), g = 'getElementsByTagName'; s.type = 'text/javascript'; s.charset = 'UTF-8'; s.async = true; s.src = ('https:' == window.location.protocol ? 'https' : 'http') + '://share.pluso.ru/pluso-like.js'; var h = d[g]('body')[0]; h.appendChild(s); } })();</script> <div class="pluso" data-background="transparent" data-options="small,round,line,horizontal,counter,theme=04" data-services="vkontakte,odnoklassniki,facebook,twitter,google,moimir,email,print"></div></div>   <div class="comments"> <a name="comments"></a> <div id="disqus_thread"></div> <script> var disqus_config = function () { this.page.url = "http://atoumus.github.io/php-manage-cron-sh.html"; this.language = "ru"; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://atoumus.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> </div> <div class="footer"> <div class="left"> <div class="social"> <a href="#" class="icon search-toggle flaticon-magnifier" title="Поиск"></a> <a href="/atom.xml" target="_blank" class="icon flaticon-rss-feed-button" title="Atom лента"></a> <a href="https://twitter.com/atoumus/" target="_blank" class="icon flaticon-twitter-logo-silhouette" title="Twitter"></a> <a href="https://plus.google.com/u/0/116624784918762784912" target="_blank" class="icon flaticon-google-plus-logo-button" title="G+"></a> </div> <div class="author-email"> <a data-email-array='{"8":"g","6":"s","12":"l","5":"u","16":"m","7":"@","4":"m","9":"m","1":"t","13":".","3":"u","10":"a","11":"i","2":"o","14":"c","15":"o","0":"a"}' href="#"></a> </div> </div> <div class="right"> <div>  <script type="text/javascript"> document.write("<a href='//www.liveinternet.ru/click' "+ "target=_blank><img src='//counter.yadro.ru/hit?t25.5;r"+ escape(document.referrer)+((typeof(screen)=="undefined")?"": ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth? screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+ ";"+Math.random()+ "' alt='' title='LiveInternet: показано число посетителей за"+ " сегодня' "+ "border='0' width='88' height='15'><\/a>") </script>  </div> <div> Atoumus Blog &copy; 2011 - 2019 </div> </div> </div> <div class="clear-both"></div> </div> <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script> <script type="text/javascript" src="/js/libs/prism.js"></script> <script type="text/javascript" src="/js/app.js"></script> </body> </html>